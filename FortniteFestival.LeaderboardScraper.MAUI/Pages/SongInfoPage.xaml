<?xml version="1.0" encoding="utf-8"?>
<ContentPage
  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:controls="clr-namespace:FortniteFestival.LeaderboardScraper.MAUI.Controls"
  x:Class="FortniteFestival.LeaderboardScraper.MAUI.Pages.SongInfoPage"
  x:Name="SongInfoPageRoot"
  Title="Song Info">
  <!-- Layered background: album art dimmed -->
  <Grid>
    <Image Source="{Binding AlbumArtPath}" Aspect="AspectFill" />
    <BoxView Color="#88000000" />
    <!-- Foreground content -->
    <Grid Padding="16" RowSpacing="20" RowDefinitions="Auto,Auto,Auto,*">
      <!-- Back button (auto width) -->
      <Border StrokeShape="RoundRectangle 24" BackgroundColor="#4B0F63" Padding="16,10" x:Name="BackButton" HorizontalOptions="Start">
        <Border.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnBackTapped" />
        </Border.GestureRecognizers>
        <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
          <Label Text="â†" FontFamily="NotoSansBold" FontAttributes="Bold" TextColor="White" />
          <Label Text="Back" FontFamily="NotoSansBold" FontAttributes="Bold" TextColor="White" />
        </HorizontalStackLayout>
      </Border>

      <!-- Split area (no container background/border) -->
      <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="32" HeightRequest="260">
        <!-- Left half: square album art -->
        <Grid Grid.Column="0" HorizontalOptions="Center" VerticalOptions="Center">
          <Border StrokeShape="RoundRectangle 18" BackgroundColor="#7A2B95" WidthRequest="220" HeightRequest="220">
            <Image Source="{Binding AlbumArtPath}" Aspect="AspectFill" />
          </Border>
        </Grid>

        <!-- Right half: centered title & artist (bold) -->
        <VerticalStackLayout Grid.Column="1" Spacing="12" HorizontalOptions="Center" VerticalOptions="Center" WidthRequest="320">
          <Label Text="{Binding Title}" FontFamily="NotoSansBold" FontAttributes="Bold" FontSize="28" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
          <Label Text="{Binding Artist}" FontFamily="NotoSansBold" FontAttributes="Bold" FontSize="18" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
        </VerticalStackLayout>
      </Grid>

      <!-- Instruments container sized to content with 90% opacity -->
      <Border Grid.Row="2" StrokeShape="RoundRectangle 26" BackgroundColor="#E6B35CD6" Padding="12" HorizontalOptions="Fill" VerticalOptions="Start" Opacity="0.9">
        <CollectionView ItemsSource="{Binding InstrumentRows}" SelectionMode="None">
          <CollectionView.ItemTemplate>
            <DataTemplate>
              <Grid Padding="10,12" ColumnDefinitions="50,*,260,Auto,Auto,Auto" ColumnSpacing="12">
                <Border Grid.Column="0" StrokeShape="Ellipse" BackgroundColor="#4B0F63" WidthRequest="48" HeightRequest="48" HorizontalOptions="Center" VerticalOptions="Center">
                  <Image Source="{Binding Icon}" WidthRequest="40" HeightRequest="40" HorizontalOptions="Center" VerticalOptions="Center" />
                </Border>
                <Label Grid.Column="1" Text="{Binding Name}" FontFamily="NotoSansBold" FontAttributes="Bold" VerticalOptions="Center" MinimumWidthRequest="92" LineBreakMode="TailTruncation" MaxLines="1" />
                <!-- Stars panel using BindableLayout -->
                <Grid Grid.Column="2" WidthRequest="260" HorizontalOptions="Center" VerticalOptions="Center">
                  <HorizontalStackLayout Spacing="4" HorizontalOptions="Center" VerticalOptions="Center" BindableLayout.ItemsSource="{Binding Stars}" IsVisible="{Binding HasScore}">
                    <BindableLayout.ItemTemplate>
                      <DataTemplate>
                        <Border StrokeShape="Ellipse" WidthRequest="48" HeightRequest="48" StrokeThickness="2" Stroke="{Binding OutlineColor}" BackgroundColor="Transparent" Padding="4" VerticalOptions="Center" HorizontalOptions="Center">
                          <Image Source="{Binding Image}" WidthRequest="40" HeightRequest="40" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                      </DataTemplate>
                    </BindableLayout.ItemTemplate>
                  </HorizontalStackLayout>
                  <Label Text="N/A" FontFamily="NotoSansBold" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding ShowNA}" />
                </Grid>
                <Label Grid.Column="3" Text="{Binding ScoreDisplay}" WidthRequest="110" IsVisible="{Binding BindingContext.ShowScore, Source={x:Reference SongInfoPageRoot}}" FontFamily="NotoSansBold" FontAttributes="Bold" VerticalOptions="Center" HorizontalTextAlignment="Center" HorizontalOptions="Center" />
                <Border Grid.Column="4" StrokeThickness="2" Padding="4,2" WidthRequest="70" IsVisible="{Binding BindingContext.ShowPercent, Source={x:Reference SongInfoPageRoot}}" HorizontalOptions="Center" VerticalOptions="Center">
                  <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                  </Border.StrokeShape>
                  <Label Text="{Binding PercentDisplay}" FontFamily="NotoSansBold" FontAttributes="Bold" VerticalOptions="Center" HorizontalTextAlignment="Center" HorizontalOptions="Center" >
                    <Label.Triggers>
                      <DataTrigger TargetType="Label" Binding="{Binding IsFullCombo}" Value="True">
                        <Setter Property="TextColor" Value="#FFD700" />
                        <Setter Property="FontAttributes" Value="Bold,Italic" />
                      </DataTrigger>
                    </Label.Triggers>
                  </Label>
                  <Border.Triggers>
                    <DataTrigger TargetType="Border" Binding="{Binding IsFullCombo}" Value="True">
                      <Setter Property="Stroke" Value="#FFD700" />
                      <Setter Property="Background" Value="#332915" />
                    </DataTrigger>
                    <DataTrigger TargetType="Border" Binding="{Binding IsFullCombo}" Value="False">
                      <Setter Property="Stroke" Value="Transparent" />
                      <Setter Property="Background" Value="Transparent" />
                    </DataTrigger>
                  </Border.Triggers>
                </Border>
                <controls:SeasonBadge Grid.Column="5" Text="{Binding SeasonDisplay}" IsVisible="{Binding BindingContext.ShowSeason, Source={x:Reference SongInfoPageRoot}}" WidthRequest="70" VerticalOptions="Center" HorizontalOptions="Center" />
              </Grid>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>
      </Border>
    </Grid>
  </Grid>
</ContentPage>
