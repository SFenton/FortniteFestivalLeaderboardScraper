<?xml version="1.0" encoding="utf-8"?>
<ContentPage
  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:controls="clr-namespace:FortniteFestival.LeaderboardScraper.MAUI.Controls"
  xmlns:conv="clr-namespace:FortniteFestival.LeaderboardScraper.MAUI.Converters"
  xmlns:vm="clr-namespace:FortniteFestival.LeaderboardScraper.MAUI.ViewModels"
  xmlns:syncfusion="clr-namespace:Syncfusion.Maui.ListView;assembly=Syncfusion.Maui.ListView"
  x:Class="FortniteFestival.LeaderboardScraper.MAUI.Pages.HomePage"
  x:DataType="vm:HomePageViewModel"
  Title="Songs"
  BackgroundColor="#9d4dbb">
  <ContentPage.Resources>
    <conv:BoolToThicknessConverter x:Key="BoolToThicknessConverter" TrueThickness="4" FalseThickness="0" />
  <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
    <Style x:Key="SortModeRadioStyle" TargetType="RadioButton">
      <Setter Property="TextColor" Value="White" />
    </Style>
  </ContentPage.Resources>
  <Grid>
    <!-- Main vertical stack: header + dynamic sections (songs / suggestions / stats / settings) -->
    <Grid x:Name="SongsStack" RowDefinitions="Auto,*,*,*">
      <!-- Shared header with hamburger (always visible) -->
      <Grid Grid.Row="0" HeightRequest="52" Padding="12,8" ColumnDefinitions="Auto,*,Auto">
        <Label x:Name="HamburgerButton" Text="☰" FontSize="24" FontFamily="NotoSansBold" TextColor="White" VerticalOptions="Center">
          <Label.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnHamburgerTapped" />
          </Label.GestureRecognizers>
        </Label>
        <!-- Optional Title could go in column 1 -->
      </Grid>
      <!-- Songs Section (replaces individually toggled rows) -->
      <Grid x:Name="SongsSection" Grid.Row="1" Grid.RowSpan="3" Margin="12,0,12,8">
        <Grid RowDefinitions="Auto,*,Auto">
          <!-- Controls -->
          <VerticalStackLayout x:Name="SongsControlsRow" Grid.Row="0" Spacing="10">
            <Border BackgroundColor="#EEEEEE" StrokeShape="RoundRectangle 22" Padding="0" HeightRequest="44">
              <SearchBar Placeholder="Search title/artist"
                         Text="{Binding Songs.Filter}"
                         FontFamily="NotoSansRegular"
                         BackgroundColor="Transparent"
                         TextColor="Black"
                         PlaceholderColor="#666666" />
            </Border>
            <Grid HeightRequest="44" ColumnDefinitions="Auto,Auto,*" ColumnSpacing="6" VerticalOptions="Center" Margin="0,0,0,8">
              <Border x:Name="FilterButton" Grid.Column="0" StrokeShape="RoundRectangle 26" BackgroundColor="#4B0F63" Padding="20,14" HorizontalOptions="Start" VerticalOptions="Center" ZIndex="10" Margin="0,0,2,0">
                <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnFilterTapped" NumberOfTapsRequired="1" /></Border.GestureRecognizers>
                <Label Text="Filter" FontFamily="NotoSansBold" TextColor="White" />
              </Border>
              <Border x:Name="SortButton" Grid.Column="1" StrokeShape="RoundRectangle 26" BackgroundColor="#4B0F63" Padding="20,14" HorizontalOptions="Start" VerticalOptions="Center" ZIndex="10" Margin="0,0,2,0">
                <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnSortTapped" NumberOfTapsRequired="1" /></Border.GestureRecognizers>
                <Label Text="Sort" FontFamily="NotoSansBold" TextColor="White" />
              </Border>
              <Border x:Name="SortDirectionButton" Grid.Column="2" StrokeShape="RoundRectangle 26" BackgroundColor="#4B0F63" Padding="20,14" HorizontalOptions="End" VerticalOptions="Center" ZIndex="10" Margin="0,0,0,0">
                <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnSortDirectionTapped" /></Border.GestureRecognizers>
                <Grid>
                  <HorizontalStackLayout x:Name="SortDirectionFull" Spacing="6" VerticalOptions="Center" IsVisible="{Binding Songs.UseCompactLayout, Converter={StaticResource InverseBoolConverter}}">
                    <Label Text="Sort Direction" FontFamily="NotoSansBold" TextColor="White" />
                    <Label x:Name="SortDirectionCaret" Text="{Binding Songs.SortDirectionCaret}" FontFamily="NotoSansBold" TextColor="White" />
                  </HorizontalStackLayout>
                  <Label x:Name="SortDirectionCaretCompact" Text="{Binding Songs.SortDirectionCaret}" FontFamily="NotoSansBold" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.UseCompactLayout}" />
                </Grid>
              </Border>
            </Grid>
          </VerticalStackLayout>
          <!-- Songs list container -->
          <Border x:Name="SongsContainerBorder" Grid.Row="1" BackgroundColor="#b35cd6" StrokeShape="RoundRectangle 26" Padding="8,8,8,8" HorizontalOptions="Fill" VerticalOptions="Fill">
            <Grid>
              <VerticalStackLayout Spacing="6" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsEmpty}">
                <Label Text="No Songs Found" FontFamily="NotoSansBold" FontSize="20" HorizontalTextAlignment="Center" />
                <Label Text="Try adjusting your filters or search to see songs." FontSize="13" Opacity="0.85" HorizontalTextAlignment="Center" />
              </VerticalStackLayout>
              <CollectionView x:Name="SongListCollection"
                              IsVisible="{Binding Songs.IsNotEmpty}"
                              ItemsSource="{Binding Songs.VisibleRows}"
                              SelectionMode="None"
                              ItemSizingStrategy="MeasureFirstItem"
                              BackgroundColor="Transparent">
                <CollectionView.ItemTemplate>
                  <DataTemplate x:DataType="vm:SongDisplayRow">
                    <Grid>
                      <Grid.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnSongRowTapped" CommandParameter="{Binding .}" />
                      </Grid.GestureRecognizers>
                      <Grid x:Name="WideSongRow" Padding="6" ColumnDefinitions="60,*,Auto" ColumnSpacing="8" IsVisible="{Binding UseCompactLayout, Converter={StaticResource InverseBoolConverter}}">
                        <Border Grid.Column="0" StrokeShape="RoundRectangle 4" WidthRequest="56" HeightRequest="56" BackgroundColor="#444444" HorizontalOptions="Start" VerticalOptions="Center">
                          <Image Source="{Binding AlbumArtPath}" Aspect="AspectFill" />
                        </Border>
                        <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                          <Label Text="{Binding Title}" FontAttributes="Bold" FontFamily="NotoSansBold" LineBreakMode="TailTruncation" />
                          <Label Text="{Binding ArtistYearDisplay}" FontSize="12" FontFamily="NotoSansRegular" LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                        <HorizontalStackLayout Grid.Column="2" Spacing="8" BindableLayout.ItemsSource="{Binding InstrumentStatuses}" VerticalOptions="Center">
                          <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="vm:InstrumentStatus">
                              <Grid WidthRequest="48" HeightRequest="48">
                                <Border IsVisible="{Binding ShowCircle}" BackgroundColor="{Binding CircleFillColor}" Stroke="{Binding CircleStrokeColor}" StrokeShape="Ellipse" StrokeThickness="3" WidthRequest="48" HeightRequest="48" />
                                <Image Source="{Binding Icon}" WidthRequest="40" HeightRequest="40" HorizontalOptions="Center" VerticalOptions="Center" />
                              </Grid>
                            </DataTemplate>
                          </BindableLayout.ItemTemplate>
                        </HorizontalStackLayout>
                      </Grid>
                      <Grid x:Name="CompactSongRow" Padding="6" ColumnDefinitions="60,*" ColumnSpacing="8" IsVisible="{Binding UseCompactLayout}">
                        <Border Grid.Column="0" StrokeShape="RoundRectangle 4" WidthRequest="56" HeightRequest="56" BackgroundColor="#444444" HorizontalOptions="Start" VerticalOptions="Center">
                          <Image Source="{Binding AlbumArtPath}" Aspect="AspectFill" />
                        </Border>
                        <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                          <Label Text="{Binding Title}" FontAttributes="Bold" FontFamily="NotoSansBold" LineBreakMode="TailTruncation" />
                          <Label Text="{Binding ArtistYearDisplay}" FontSize="12" FontFamily="NotoSansRegular" LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                      </Grid>
                    </Grid>
                  </DataTemplate>
                </CollectionView.ItemTemplate>
              </CollectionView>
              <Grid x:Name="SongListLoadingOverlay" BackgroundColor="#c86fe8" Opacity="0.92" IsVisible="False">
                <VerticalStackLayout Spacing="10" HorizontalOptions="Center" VerticalOptions="Center">
                  <ActivityIndicator x:Name="SongListLoadingSpinner" IsRunning="True" WidthRequest="42" HeightRequest="42" Color="White" />
                  <Label x:Name="SongListLoadingLabel" Text="Updating songs..." FontFamily="NotoSansBold" TextColor="White" HorizontalTextAlignment="Center" />
                </VerticalStackLayout>
              </Grid>
            </Grid>
          </Border>
          <!-- Update Scores Button -->
          <Grid x:Name="UpdateScoresRow" Grid.Row="2" Padding="0" HorizontalOptions="Fill" VerticalOptions="End" Margin="0,6,0,0">
            <Border x:Name="UpdateScoresButton" StrokeShape="RoundRectangle 26" BackgroundColor="#4B0F63" Padding="24,16" HorizontalOptions="End" HeightRequest="48">
              <Border.Shadow>
                <Shadow Brush="#000000" Opacity="0.35" Offset="0,4" Radius="14" />
              </Border.Shadow>
              <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnUpdateScoresTapped" NumberOfTapsRequired="1" />
              </Border.GestureRecognizers>
              <Grid>
                <Label x:Name="UpdateScoresLabel" Text="Update Scores" FontFamily="NotoSansBold" TextColor="White" />
                <ActivityIndicator x:Name="UpdateScoresSpinner" IsRunning="False" IsVisible="False" Color="White" />
              </Grid>
            </Border>
          </Grid>
        </Grid>
      </Grid>

      <!-- Suggestions Section (overlays rows 1-3 when active) -->
      <Grid x:Name="SuggestionsSection" Grid.Row="1" Grid.RowSpan="3" IsVisible="False" Margin="12,0,12,8">
  <Grid Padding="0">
          <Grid RowDefinitions="*,Auto">
            <ScrollView x:Name="SuggestionsScroll" Grid.Row="0" Scrolled="OnSuggestionsScrolled">
              <VerticalStackLayout x:Name="SuggestionsContentStack" Spacing="18" Padding="0,0,0,0" />
            </ScrollView>
            <ActivityIndicator x:Name="SuggestionsLoadingIndicator" Grid.Row="1" IsRunning="False" IsVisible="False" HorizontalOptions="Center" Margin="0,0,0,8" />
          </Grid>
          <VerticalStackLayout x:Name="SuggestionsEmptyState" Spacing="8" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="False">
            <Label Text="No Suggestions Available" FontFamily="NotoSansBold" FontSize="20" HorizontalTextAlignment="Center" />
            <Label Text="Sync your scores to generate suggestions on what to play next." FontSize="13" Opacity="0.85" HorizontalTextAlignment="Center" />
          </VerticalStackLayout>
          <!-- Center overlay spinner for initial suggestions load -->
          <Grid x:Name="SuggestionsInitialOverlay" BackgroundColor="#00000066" IsVisible="False">
            <VerticalStackLayout Spacing="14" HorizontalOptions="Center" VerticalOptions="Center">
              <ActivityIndicator x:Name="SuggestionsInitialSpinner" IsRunning="True" WidthRequest="56" HeightRequest="56" Color="White" />
            </VerticalStackLayout>
          </Grid>
        </Grid>
      </Grid>

      <!-- Statistics Section placeholder -->
  <Grid x:Name="StatisticsSection" Grid.Row="1" Grid.RowSpan="3" IsVisible="False" Margin="12,0,12,8">
        <Border BackgroundColor="#b35cd6" StrokeShape="RoundRectangle 26" Padding="24">
          <VerticalStackLayout Spacing="12" HorizontalOptions="Center" VerticalOptions="Center">
            <Label Text="Statistics" FontFamily="NotoSansBold" FontSize="24" />
            <Label Text="(Placeholder)" />
          </VerticalStackLayout>
        </Border>
      </Grid>

      <!-- Settings Section placeholder -->
  <Grid x:Name="SettingsSection" Grid.Row="1" Grid.RowSpan="3" IsVisible="False" Margin="12,0,12,8">
        <Border BackgroundColor="#b35cd6" StrokeShape="RoundRectangle 26" Padding="24">
          <VerticalStackLayout Spacing="12" HorizontalOptions="Center" VerticalOptions="Center">
            <Label Text="Settings" FontFamily="NotoSansBold" FontSize="24" />
            <Label Text="(Placeholder)" />
          </VerticalStackLayout>
        </Border>
      </Grid>
    </Grid>
    <!-- Navigation Drawer Overlay -->
    <Grid x:Name="NavDrawerOverlay" IsVisible="False" BackgroundColor="#00000055">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="260" />
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>
      <!-- Drawer panel -->
      <Border BackgroundColor="#4B0F63" StrokeShape="RoundRectangle 0" Padding="16,20,16,28" WidthRequest="260">
        <VerticalStackLayout Spacing="18">
          <!-- Header row with close button -->
          <Grid ColumnDefinitions="*,Auto" HeightRequest="24">
            <Label Text="" />
            <Label Text="✕" TextColor="White" FontSize="18" VerticalOptions="Center">
              <Label.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnCloseDrawerTapped" />
              </Label.GestureRecognizers>
            </Label>
          </Grid>
          <!-- Suggestions (conditional) -->
          <Grid x:Name="SuggestionsNavItem" ColumnDefinitions="Auto,*" HeightRequest="40">
            <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnNavSuggestionsTapped" /></Grid.GestureRecognizers>
            <Label Text="💡" FontSize="20" VerticalOptions="Center" />
            <Label Grid.Column="1" Text="Suggestions" FontFamily="NotoSansBold" TextColor="White" VerticalOptions="Center" />
          </Grid>
          <!-- Songs -->
          <Grid ColumnDefinitions="Auto,*" HeightRequest="40">
            <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnNavSongsTapped" /></Grid.GestureRecognizers>
            <Label Text="🎵" FontSize="20" VerticalOptions="Center" />
            <Label Grid.Column="1" Text="Songs" FontFamily="NotoSansBold" TextColor="White" VerticalOptions="Center" />
          </Grid>
          <!-- Statistics -->
            <Grid ColumnDefinitions="Auto,*" HeightRequest="40">
            <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnNavStatisticsTapped" /></Grid.GestureRecognizers>
            <Label Text="📊" FontSize="20" VerticalOptions="Center" />
            <Label Grid.Column="1" Text="Statistics" FontFamily="NotoSansBold" TextColor="White" VerticalOptions="Center" />
          </Grid>
          <!-- Settings -->
          <Grid ColumnDefinitions="Auto,*" HeightRequest="40">
            <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnNavSettingsTapped" /></Grid.GestureRecognizers>
            <Label Text="⚙️" FontSize="20" VerticalOptions="Center" />
            <Label Grid.Column="1" Text="Settings" FontFamily="NotoSansBold" TextColor="White" VerticalOptions="Center" />
          </Grid>
        </VerticalStackLayout>
      </Border>
      <!-- Click catcher to close -->
      <Grid Grid.Column="1">
        <Grid.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnCloseDrawerTapped" />
        </Grid.GestureRecognizers>
      </Grid>
    </Grid>
    <!-- Centered loading overlay -->
    <VerticalStackLayout x:Name="LoadingOverlay" Spacing="12" HorizontalOptions="Center" VerticalOptions="Center">
      <ActivityIndicator x:Name="InitSpinner" IsRunning="True" WidthRequest="48" HeightRequest="48" Color="White" />
      <Label x:Name="LoadingLabel" Text="Updating songs..." HorizontalTextAlignment="Center" TextColor="White" />
    </VerticalStackLayout>


    <!-- Authentication Modal Overlay (refactored to fixed header/footer & scrollable content) -->
  <Grid x:Name="AuthModal" BackgroundColor="#00000088" IsVisible="False" Padding="24">
      <Grid HorizontalOptions="Center" VerticalOptions="Center" RowDefinitions="Auto,*,Auto" MaximumWidthRequest="560" MinimumWidthRequest="280">
        <Border Grid.RowSpan="3" StrokeShape="RoundRectangle 18" BackgroundColor="#4B0F63" Padding="28" HorizontalOptions="Fill" VerticalOptions="Center">
          <Border.Shadow>
            <Shadow Brush="#000000" Opacity="0.4" Offset="0,6" Radius="22" />
          </Border.Shadow>
          <Grid RowDefinitions="Auto,*,Auto" RowSpacing="18">
            <!-- Header -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
              <Label Text="Authenticate" FontFamily="NotoSansBold" FontSize="20" VerticalOptions="Center" />
              <Border x:Name="CloseAuthButton" Grid.Column="1" Padding="18,8" StrokeShape="RoundRectangle 26" BackgroundColor="#444444" VerticalOptions="Center">
                <Border.Shadow>
                  <Shadow Brush="#000000" Opacity="0.35" Offset="0,4" Radius="14" />
                </Border.Shadow>
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnCloseAuth" />
                </Border.GestureRecognizers>
                <Label Text="Cancel" FontSize="14" FontFamily="NotoSansBold" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
              </Border>
            </Grid>
            <!-- Scrollable Content -->
            <ScrollView Grid.Row="1">
              <VerticalStackLayout Spacing="18">
                <VerticalStackLayout Spacing="8">
                  <Label Text="Exchange Code" FontFamily="NotoSansBold" />
                  <Border BackgroundColor="#EEEEEE" StrokeShape="RoundRectangle 22" Padding="14,0" HeightRequest="44">
                    <Entry x:Name="AuthCodeEntry" Placeholder="Paste exchange code" TextChanged="OnAuthCodeChanged" BackgroundColor="Transparent" TextColor="Black" PlaceholderColor="#666666" FontFamily="NotoSansRegular" />
                  </Border>
                  <Label FontSize="12" Text="Put your Epic Games authorization code here to allow Festival Scraper to pull your scores." LineBreakMode="WordWrap" />
                </VerticalStackLayout>
              </VerticalStackLayout>
            </ScrollView>
            <!-- Footer -->
            <Grid Grid.Row="2">
              <Button x:Name="AuthActionButton" Text="Get Code" Clicked="OnAuthActionButtonClicked" BackgroundColor="#2D82E6" TextColor="White" FontFamily="NotoSansBold" />
            </Grid>
          </Grid>
        </Border>
      </Grid>
    </Grid>

    <!-- Filter Modal Overlay -->
  <Grid x:Name="FilterModal" BackgroundColor="#00000088" IsVisible="False" Padding="24">
      <!-- Outer grid ensures min horizontal padding; inner border centers with max width -->
      <Grid HorizontalOptions="Center" VerticalOptions="Center" RowDefinitions="Auto,*,Auto" MaximumWidthRequest="560" MinimumWidthRequest="280">
        <Border Grid.RowSpan="3" StrokeShape="RoundRectangle 18" BackgroundColor="#4B0F63" Padding="28" HorizontalOptions="Fill" VerticalOptions="Center">
          <Border.Shadow>
            <Shadow Brush="#000000" Opacity="0.4" Offset="0,6" Radius="22" />
          </Border.Shadow>
          <!-- Layout grid inside border: header / scroll / footer -->
          <Grid RowDefinitions="Auto,*,Auto" RowSpacing="18">
            <!-- Header -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
              <Label Text="Filter Songs" FontFamily="NotoSansBold" FontSize="20" VerticalOptions="Center" />
              <Border x:Name="CloseFilterButton" Grid.Column="1" Padding="18,8" StrokeShape="RoundRectangle 26" BackgroundColor="#444444" VerticalOptions="Center">
                <Border.Shadow>
                  <Shadow Brush="#000000" Opacity="0.35" Offset="0,4" Radius="14" />
                </Border.Shadow>
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnCloseFilter" />
                </Border.GestureRecognizers>
                <Label Text="Cancel" FontSize="14" FontFamily="NotoSansBold" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
              </Border>
            </Grid>
            <!-- Scrollable Content -->
            <ScrollView Grid.Row="1">
              <VerticalStackLayout Spacing="18">
                <!-- Missing Criteria (two-column normal, single-column compact) -->
                <VerticalStackLayout Spacing="8">
                  <Label Text="Missing" FontFamily="NotoSansBold" />
                  <!-- Normal layout -->
                  <Grid x:Name="MissingGridNormal" ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="32" RowSpacing="8" IsVisible="{Binding Songs.UseCompactLayout, Converter={StaticResource InverseBoolConverter}}">
                    <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="6" VerticalOptions="Center">
                      <CheckBox IsChecked="{Binding Songs.MissingPadFCs}" />
                      <Label Text="Missing Pad FCs" FontSize="12" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                    <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="6" VerticalOptions="Center">
                      <CheckBox IsChecked="{Binding Songs.MissingPadScores}" />
                      <Label Text="Missing Pad Scores" FontSize="12" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                    <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Spacing="6" VerticalOptions="Center">
                      <CheckBox IsChecked="{Binding Songs.MissingProFCs}" />
                      <Label Text="Missing Pro FCs" FontSize="12" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                    <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="6" VerticalOptions="Center">
                      <CheckBox IsChecked="{Binding Songs.MissingProScores}" />
                      <Label Text="Missing Pro Scores" FontSize="12" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                  </Grid>
                  <!-- Compact single-column layout -->
                  <VerticalStackLayout x:Name="MissingGridCompact" Spacing="6" IsVisible="{Binding Songs.UseCompactLayout}">
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center"><CheckBox IsChecked="{Binding Songs.MissingPadFCs}" /><Label Text="Missing Pad FCs" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center"><CheckBox IsChecked="{Binding Songs.MissingPadScores}" /><Label Text="Missing Pad Scores" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center"><CheckBox IsChecked="{Binding Songs.MissingProFCs}" /><Label Text="Missing Pro FCs" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center"><CheckBox IsChecked="{Binding Songs.MissingProScores}" /><Label Text="Missing Pro Scores" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                  </VerticalStackLayout>
                </VerticalStackLayout>
                <!-- Instruments (two-column normal, single-column compact) -->
                <VerticalStackLayout Spacing="8">
                  <Label Text="Instruments" FontFamily="NotoSansBold" />
                  <Grid ColumnDefinitions="*,*" ColumnSpacing="36" IsVisible="{Binding Songs.UseCompactLayout, Converter={StaticResource InverseBoolConverter}}">
                    <VerticalStackLayout Spacing="6">
                      <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeLead}" /><Label Text="Lead" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                      <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeBass}" /><Label Text="Bass" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                      <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeDrums}" /><Label Text="Drums" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                      <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeVocals}" /><Label Text="Vocals" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    </VerticalStackLayout>
                    <VerticalStackLayout Grid.Column="1" Spacing="6">
                      <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeProGuitar}" /><Label Text="Pro Guitar" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                      <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeProBass}" /><Label Text="Pro Bass" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    </VerticalStackLayout>
                  </Grid>
                  <VerticalStackLayout Spacing="6" IsVisible="{Binding Songs.UseCompactLayout}">
                    <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeLead}" /><Label Text="Lead" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeBass}" /><Label Text="Bass" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeDrums}" /><Label Text="Drums" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeVocals}" /><Label Text="Vocals" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeProGuitar}" /><Label Text="Pro Guitar" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="6"><CheckBox IsChecked="{Binding Songs.IncludeProBass}" /><Label Text="Pro Bass" FontSize="12" VerticalOptions="Center" /></HorizontalStackLayout>
                  </VerticalStackLayout>
                </VerticalStackLayout>
              </VerticalStackLayout>
            </ScrollView>
            <!-- Footer Actions -->
            <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="16">
              <Button Text="Reset" Clicked="OnResetFilter" BackgroundColor="#C62828" TextColor="White" FontFamily="NotoSansBold" />
              <Button Grid.Column="1" Text="Apply" Clicked="OnApplyFilter" BackgroundColor="#2D82E6" TextColor="White" FontFamily="NotoSansBold" />
            </Grid>
          </Grid>
        </Border>
      </Grid>
    </Grid>
    <!-- Sort Modal Overlay -->
  <Grid x:Name="SortModal" BackgroundColor="#00000088" IsVisible="False" Padding="24">
      <Grid HorizontalOptions="Center" VerticalOptions="Center" RowDefinitions="Auto,*,Auto" MaximumWidthRequest="560" MinimumWidthRequest="280">
        <Border Grid.RowSpan="3" StrokeShape="RoundRectangle 18" BackgroundColor="#4B0F63" Padding="28" HorizontalOptions="Fill" VerticalOptions="Center">
          <Border.Shadow>
            <Shadow Brush="#000000" Opacity="0.4" Offset="0,6" Radius="22" />
          </Border.Shadow>
          <Grid RowDefinitions="Auto,*,Auto" RowSpacing="18">
            <!-- Header -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
              <Label Text="Sort Songs" FontFamily="NotoSansBold" FontSize="20" VerticalOptions="Center" />
              <Border x:Name="CloseSortButton" Grid.Column="1" Padding="18,8" StrokeShape="RoundRectangle 26" BackgroundColor="#444444" VerticalOptions="Center">
                <Border.Shadow>
                  <Shadow Brush="#000000" Opacity="0.35" Offset="0,4" Radius="14" />
                </Border.Shadow>
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnCloseSort" />
                </Border.GestureRecognizers>
                <Label Text="Cancel" FontSize="14" FontFamily="NotoSansBold" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
              </Border>
            </Grid>
            <!-- Content area now scrollable (options + instrument order); instrument list auto-fits (no internal scroll). -->
            <ScrollView Grid.Row="1">
              <VerticalStackLayout Spacing="24">
                <!-- Sort Mode Radio Buttons (two-column normal, single-column compact) -->
                <VerticalStackLayout Spacing="8">
                  <Label Text="Mode" FontFamily="NotoSansBold" />
                  <Grid ColumnDefinitions="*,*" ColumnSpacing="36" IsVisible="{Binding Songs.UseCompactLayout, Converter={StaticResource InverseBoolConverter}}">
                    <VerticalStackLayout Spacing="10">
                      <Grid>
                        <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnSortOptionTapped" CommandParameter="title" /></Grid.GestureRecognizers>
                        <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                          <Grid WidthRequest="20" HeightRequest="20"><Ellipse Stroke="#2D82E6" StrokeThickness="2" /><Ellipse Fill="#2D82E6" WidthRequest="16" HeightRequest="16" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByTitle}" /><Ellipse Fill="White" WidthRequest="8" HeightRequest="8" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByTitle}" /></Grid>
                          <Label Text="Title" FontSize="14" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                      </Grid>
                      <Grid>
                        <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnSortOptionTapped" CommandParameter="artist" /></Grid.GestureRecognizers>
                        <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                          <Grid WidthRequest="20" HeightRequest="20"><Ellipse Stroke="#2D82E6" StrokeThickness="2" /><Ellipse Fill="#2D82E6" WidthRequest="16" HeightRequest="16" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByArtist}" /><Ellipse Fill="White" WidthRequest="8" HeightRequest="8" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByArtist}" /></Grid>
                          <Label Text="Artist" FontSize="14" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                      </Grid>
                    </VerticalStackLayout>
                    <VerticalStackLayout Grid.Column="1" Spacing="10">
                      <Grid>
                        <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnSortOptionTapped" CommandParameter="hasfc" /></Grid.GestureRecognizers>
                        <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                          <Grid WidthRequest="20" HeightRequest="20"><Ellipse Stroke="#2D82E6" StrokeThickness="2" /><Ellipse Fill="#2D82E6" WidthRequest="16" HeightRequest="16" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByHasFC}" /><Ellipse Fill="White" WidthRequest="8" HeightRequest="8" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByHasFC}" /></Grid>
                          <Label Text="Has FC" FontSize="14" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                      </Grid>
                    </VerticalStackLayout>
                  </Grid>
                  <VerticalStackLayout Spacing="10" IsVisible="{Binding Songs.UseCompactLayout}">
                    <Grid>
                      <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnSortOptionTapped" CommandParameter="title" /></Grid.GestureRecognizers>
                      <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                        <Grid WidthRequest="20" HeightRequest="20"><Ellipse Stroke="#2D82E6" StrokeThickness="2" /><Ellipse Fill="#2D82E6" WidthRequest="16" HeightRequest="16" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByTitle}" /><Ellipse Fill="White" WidthRequest="8" HeightRequest="8" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByTitle}" /></Grid>
                        <Label Text="Title" FontSize="14" VerticalOptions="Center" />
                      </HorizontalStackLayout>
                    </Grid>
                    <Grid>
                      <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnSortOptionTapped" CommandParameter="artist" /></Grid.GestureRecognizers>
                      <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                        <Grid WidthRequest="20" HeightRequest="20"><Ellipse Stroke="#2D82E6" StrokeThickness="2" /><Ellipse Fill="#2D82E6" WidthRequest="16" HeightRequest="16" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByArtist}" /><Ellipse Fill="White" WidthRequest="8" HeightRequest="8" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByArtist}" /></Grid>
                        <Label Text="Artist" FontSize="14" VerticalOptions="Center" />
                      </HorizontalStackLayout>
                    </Grid>
                    <Grid>
                      <Grid.GestureRecognizers><TapGestureRecognizer Tapped="OnSortOptionTapped" CommandParameter="hasfc" /></Grid.GestureRecognizers>
                      <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                        <Grid WidthRequest="20" HeightRequest="20"><Ellipse Stroke="#2D82E6" StrokeThickness="2" /><Ellipse Fill="#2D82E6" WidthRequest="16" HeightRequest="16" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByHasFC}" /><Ellipse Fill="White" WidthRequest="8" HeightRequest="8" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding Songs.IsSortByHasFC}" /></Grid>
                        <Label Text="Has FC" FontSize="14" VerticalOptions="Center" />
                      </HorizontalStackLayout>
                    </Grid>
                  </VerticalStackLayout>
                </VerticalStackLayout>
                <!-- Primary Instrument Order (auto-fit) -->
                <VerticalStackLayout Spacing="8">
                  <Label Text="Primary Instrument Order" FontFamily="NotoSansBold" />
                  <Border StrokeShape="RoundRectangle 18" BackgroundColor="#5D1A75" Padding="8">
                    <syncfusion:SfListView x:Name="InstrumentListView"
                                             ItemsSource="{Binding Songs.PrimaryInstrumentOrder}"
                                             DragStartMode="OnDragIndicator"
                                             SelectionMode="None"
                                             AutoFitMode="Height">
                      <syncfusion:SfListView.DragDropController>
                        <syncfusion:DragDropController UpdateSource="True" />
                      </syncfusion:SfListView.DragDropController>
                      <syncfusion:SfListView.ItemTemplate>
                        <DataTemplate x:DataType="vm:InstrumentOrderItem">
                          <Grid Padding="6" ColumnDefinitions="Auto,*">
                            <syncfusion:DragIndicatorView Grid.Column="0"
                                                           ListView="{x:Reference InstrumentListView}"
                                                           VerticalOptions="Center"
                                                           HorizontalOptions="Center">
                              <Grid WidthRequest="20" HeightRequest="20" Margin="0,0,8,0" VerticalOptions="Center">
                                <VerticalStackLayout Spacing="2" VerticalOptions="Center" HorizontalOptions="Center">
                                  <BoxView WidthRequest="14" HeightRequest="2" Color="#BBBBBB" />
                                  <BoxView WidthRequest="14" HeightRequest="2" Color="#BBBBBB" />
                                  <BoxView WidthRequest="14" HeightRequest="2" Color="#BBBBBB" />
                                </VerticalStackLayout>
                              </Grid>
                            </syncfusion:DragIndicatorView>
                            <Label Grid.Column="1" Text="{Binding DisplayName}" FontSize="14" VerticalOptions="Center" />
                          </Grid>
                        </DataTemplate>
                      </syncfusion:SfListView.ItemTemplate>
                    </syncfusion:SfListView>
                  </Border>
                  <Label FontSize="10" Text="Drag to reorder priority. Sorting by Has FC uses contiguous FCs from the top of this list." />
                </VerticalStackLayout>
              </VerticalStackLayout>
            </ScrollView>
            <!-- Footer -->
            <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="16">
              <Button Text="Reset" Clicked="OnResetSort" BackgroundColor="#C62828" TextColor="White" FontFamily="NotoSansBold" />
              <Button Grid.Column="1" Text="Apply" Clicked="OnApplySort" BackgroundColor="#2D82E6" TextColor="White" FontFamily="NotoSansBold" />
            </Grid>
          </Grid>
        </Border>
      </Grid>
    </Grid>
  </Grid>
</ContentPage>
